# Maintainer: ≈Åukasz Fuszara <lukaszfuszara1990@gmail.com>

_realname=mono
pkgbase="mingw-w64-${_realname}"
pkgname="${MINGW_PACKAGE_PREFIX}-${_realname}"
_pkgver=4.8.0
pkgver=${_pkgver}.495
pkgrel=1
pkgdesc="Free implementation of the .NET platform including runtime and compiler"
arch=('any')
license=('GPL' 'LGPL2.1' 'MPL')
url="http://www.mono-project.com/"
depends=("${MINGW_PACKAGE_PREFIX}-zlib" 
         "${MINGW_PACKAGE_PREFIX}-python2" 
         "${MINGW_PACKAGE_PREFIX}-ca-certificates" 
         "${MINGW_PACKAGE_PREFIX}-gcc-libs" 
         "${MINGW_PACKAGE_PREFIX}-libiconv")
source=(http://download.mono-project.com/sources/mono/${_realname}-${pkgver}.tar.bz2
        monopatch)
sha256sums=('7ba62e6f42559d58dc447a19fc1cb2a9c7977d6c6e21e1e335f73917dea120cb
            569fb0c066d8b09036704fad235930ba534d8fd3727febc92e88d8094aa57627')

prepare() {
 local PREFIX_WIN=$(cygpath -wm ${MINGW_PREFIX})

 cd "${srcdir}/${_realname}-${_pkgver}"
 cp ./mcs/build/platforms/linux.make ./mcs/build/platforms/win32.make
 patch -Np1 -i "${srcdir}/mono-4.8.0-msys2.patch"
}

build() {
  local PREFIX_WIN=$(cygpath -wm ${MINGW_PREFIX})

  cd "${srcdir}/${_realname}-${_pkgver}"
  
  # build mono
  ./configure \
    --prefix=${MINGW_PREFIX} \
    --target=${MINGW_CHOST} \
    --host=${MINGW_CHOST} \
    --enable-parallel-mark \
    --program-transform-name="" \
    --disable-boehm \
    --with-moonlight=no
  
  make get-monolite-latest
  
  mkdir -p ./mono/mini/lib/mono/4.5/
  cp ./mcs/class/lib/monolite/* ./mono/mini/lib/mono/4.5/
  
  make
}

package() {
  local PREFIX_WIN=$(cygpath -wm ${MINGW_PREFIX})
  
  cd "${srcdir}"/${_realname}-${_pkgver}
  make DESTDIR="${pkgdir}" install
}
