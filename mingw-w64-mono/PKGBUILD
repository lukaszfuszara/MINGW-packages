# Maintainer: ≈Åukasz Fuszara <lukaszfuszara1990@gmail.com>

_realname=mono
pkgbase="mingw-w64-${_realname}"
pkgname="${MINGW_PACKAGE_PREFIX}-${_realname}"
_pkgver=4.8.0
pkgver=${_pkgver}.495
pkgrel=1
pkgdesc="Free implementation of the .NET platform including runtime and compiler"
arch=('any')
license=('GPL' 'LGPL2.1' 'MPL')
url="http://www.mono-project.com/"
depends=("${MINGW_PACKAGE_PREFIX}-zlib" 
         "${MINGW_PACKAGE_PREFIX}-python2" 
         "${MINGW_PACKAGE_PREFIX}-ca-certificates" 
         "${MINGW_PACKAGE_PREFIX}-gcc-libs" 
         "${MINGW_PACKAGE_PREFIX}-libiconv")
source=(http://download.mono-project.com/sources/mono/${_realname}-${pkgver}.tar.bz2
        https://raw.githubusercontent.com/lukaszfuszara/MINGW-packages/master/mingw-w64-mono/mono-4.8.0-ignore-reference-assemblies.patch)
sha256sums=('7ba62e6f42559d58dc447a19fc1cb2a9c7977d6c6e21e1e335f73917dea120cb'
            '77dd29942de5e28d195fffbe404cdfce632dc825af00c4aeca452fceb1869a3f')

prepare() {
 local PREFIX_WIN=$(cygpath -wm ${MINGW_PREFIX})

 cd "${srcdir}/${_realname}-${_pkgver}"
 
 patch -Np1 -i "${srcdir}/mono-4.8.0-ignore-reference-assemblies.patch"
}

build() {
  local PREFIX_WIN=$(cygpath -wm ${MINGW_PREFIX})

  cd "${srcdir}/${_realname}-${_pkgver}"
  
  cp ./mcs/build/platforms/linux.make ./mcs/build/platforms/win32.make
  
  # build mono
  MSYSTEM=MINGW ./configure \
                --prefix=${MINGW_PREFIX} \
                --target=${MINGW_CHOST} \
                --host=${MINGW_CHOST} \
                --enable-parallel-mark \
                --program-transform-name="" \
                --with-gc=included \
                --disable-rpath \
                --with-moonlight=no
  make
}

package() {
  local PREFIX_WIN=$(cygpath -wm ${MINGW_PREFIX})
  MSYSTEM=MINGW
  
  cd "${srcdir}"/${_realname}-${_pkgver}
  make DESTDIR="${pkgdir}" install
}
